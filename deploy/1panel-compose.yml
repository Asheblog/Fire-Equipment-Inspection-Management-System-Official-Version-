version: "3.9"

services:
  fire-system:
    image: ${APP_IMAGE:?请设置 APP_IMAGE，例如 ghcr.io/<owner>/<repo>:latest}
    container_name: fire-safety-system
    restart: unless-stopped
    ports:
      - "${PORT:-3001}:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: ${DATABASE_URL:-file:../data/fire_safety.db}
      JWT_SECRET: ${JWT_SECRET:?请设置 JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:?请设置 JWT_REFRESH_SECRET}
      TZ: ${TZ:-Asia/Shanghai}
    volumes:
      - ./storage/data:/app/backend/data
      - ./storage/uploads:/app/backend/uploads
      - ./storage/logs:/app/backend/logs
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:3001/status').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
